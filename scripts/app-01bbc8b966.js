!function(){window.APP_DB={locations:[{places:[{location:{latitude:56.314362,longitude:43.994766},name:"Вход с ул. Горького"}],type:"metro",schedules:[{times:[[5,31],[5,43],[5,50],[6,5],[6,18],[6,32],[6,44],[6,54],[7,3],[7,9],[7,15],[7,21],[7,27],[7,33],[7,39],[7,45],[7,52],[7,58],[8,4],[8,10],[8,16],[8,22],[8,28],[8,34],[8,40],[8,46],[8,52],[8,58],[9,4],[9,10],[9,16],[9,22],[9,28],[9,34],[9,40],[9,46],[9,52],[10,4],[10,16],[10,28],[10,40],[10,52],[11,4],[11,16],[11,28],[11,40],[11,52],[12,4],[12,16],[12,28],[12,40],[12,52],[13,4],[13,16],[13,28],[13,40],[13,52],[14,4],[14,16],[14,28],[14,40],[14,52],[15,4],[15,16],[15,25],[15,31],[15,37],[15,43],[15,49],[15,55],[16,1],[16,7],[16,13],[16,19],[16,25],[16,31],[16,37],[16,43],[16,49],[16,55],[17,1],[17,7],[17,13],[17,19],[17,25],[17,31],[17,37],[17,43],[17,49],[17,55],[18,1],[18,7],[18,13],[18,19],[18,25],[18,31],[18,37],[18,43],[18,49],[18,55],[19,1],[19,7],[19,13],[19,19],[19,25],[19,31],[19,37],[19,43],[19,49],[19,55],[20,1],[20,7],[20,13],[20,25],[20,37],[20,49],[21,1],[21,13],[21,25],[21,37],[21,51],[22,5],[22,17],[22,31],[22,53],[23,17],[23,40],[0,15]],to:"m-moskovskaya"}],id:"m-gorky",name:'Метро "Горьковская"'},{places:[{location:{latitude:56.321376,longitude:43.945503},name:"Вход с Вокзала"}],type:"metro",schedules:[{times:[[5,20],[5,30],[5,41],[5,56],[6,9],[6,23],[6,35],[6,45],[6,54],[7,0],[7,6],[7,12],[7,18],[7,24],[7,30],[7,36],[7,43],[7,49],[7,55],[8,1],[8,7],[8,13],[8,19],[8,24],[8,31],[8,37],[8,43],[8,49],[8,55],[9,1],[9,7],[9,13],[9,19],[9,25],[9,31],[9,37],[9,43],[9,55],[10,7],[10,19],[10,31],[10,43],[10,55],[11,7],[11,19],[11,31],[11,43],[11,55],[12,7],[12,19],[12,31],[12,43],[12,55],[13,7],[13,19],[13,31],[13,43],[13,55],[14,7],[14,19],[14,31],[14,43],[14,55],[15,7],[15,16],[15,22],[15,28],[15,34],[15,40],[15,46],[15,52],[15,58],[16,4],[16,10],[16,16],[16,22],[16,28],[16,34],[16,40],[16,46],[16,52],[16,58],[17,4],[17,10],[17,16],[17,22],[17,28],[17,34],[17,40],[17,46],[17,52],[17,58],[18,4],[18,10],[18,16],[18,22],[18,28],[18,34],[18,40],[18,46],[18,52],[18,58],[19,4],[19,10],[19,16],[19,22],[19,28],[19,34],[19,40],[19,46],[19,52],[19,58],[20,4],[20,16],[20,28],[20,40],[20,52],[21,4],[21,16],[21,28],[21,40],[21,52],[22,4],[22,22],[22,39],[23,5],[23,28],[23,55],[0,16],[0,48]],to:"m-gorky"},{times:[[5,20],[5,38],[5,53],[6,5],[6,20],[6,30],[6,42],[6,52],[7,5],[7,17],[7,29],[7,41],[7,54],[8,6],[8,18],[8,30],[8,42],[8,54],[9,6],[9,18],[9,30],[9,42],[9,52],[10,3],[10,7],[10,15],[10,27],[10,39],[10,51],[11,3],[11,15],[11,27],[11,39],[11,51],[12,3],[12,15],[12,27],[12,39],[12,51],[13,3],[13,15],[13,27],[13,39],[13,51],[14,3],[14,15],[14,27],[14,39],[14,51],[15,3],[15,15],[15,27],[15,39],[15,51],[16,3],[16,15],[16,27],[16,39],[16,51],[17,3],[17,15],[17,27],[17,39],[17,51],[18,3],[18,15],[18,27],[18,39],[18,51],[19,3],[19,15],[19,27],[19,39],[19,51],[20,3],[20,12],[20,24],[20,36],[20,48],[21,0],[21,12],[21,24],[21,36],[21,48],[22,0],[22,15],[22,31],[22,45],[23,10],[23,33],[23,54],[0,21],[0,47]],to:"m-burevestnik"}],id:"m-moskovskaya",name:'Метро "Московская"'},{places:[{location:{latitude:56.3332749,longitude:43.8940854},name:"Вход"}],type:"metro",schedules:[{times:[[5,32],[5,51],[6,6],[6,20],[6,34],[6,46],[6,55],[7,3],[7,15],[7,27],[7,39],[7,52],[8,4],[8,16],[8,28],[8,40],[8,52],[9,4],[9,16],[9,28],[9,40],[9,52],[10,5],[10,19],[10,31],[10,43],[10,55],[11,7],[11,19],[11,31],[11,43],[11,55],[12,7],[12,19],[12,31],[12,43],[12,55],[13,7],[13,19],[13,31],[13,43],[13,55],[14,7],[14,19],[14,31],[14,43],[14,55],[15,7],[15,18],[15,25],[15,37],[15,49],[16,1],[16,13],[16,25],[16,37],[16,49],[17,1],[17,13],[17,25],[17,37],[17,49],[18,1],[18,13],[18,25],[18,37],[18,49],[19,1],[19,13],[19,25],[19,37],[19,49],[20,1],[20,17],[20,28],[20,40],[20,52],[21,4],[21,16],[21,28],[21,40],[21,52],[22,5],[22,18],[22,31],[22,41],[22,55],[23,20],[23,43],[0,5]],to:"m-moskovskaya"}],id:"m-burevestnik",name:'Метро "Бурувестник"'},{places:[{location:{latitude:56.3217146,longitude:43.9460467},name:"Вход"}],type:"railway",schedules:[{times:[[5,0],[5,50],[6,28],[7,20],[8,30],[10,5],[12,53],[14,18],[15,20],[16,0],[16,20],[16,30],[17,19],[17,27],[18,25],[19,30],[20,30],[21,50]],to:"v-dzerzhinsk"}],id:"v-nn-moskovsky",name:'Вокзал "Московский" (НН)'},{places:[{location:{latitude:56.228459,longitude:43.454128},name:"Вход"}],type:"railway",schedules:[{times:[[5,15],[5,55],[6,25],[6,35],[7,2],[7,33],[7,44],[8,32],[9,8],[9,18],[10,28],[14,30],[15,5],[16,22],[17,30],[17,58],[19,11],[19,59],[20,53]],to:"v-nn-moskovsky"}],id:"v-dzerzhinsk",name:"Вокзал Дзержинск"},{places:[{location:{latitude:56.244057,longitude:43.463199},time_offset:600,name:"У Шпиля"},{location:{latitude:56.226783,longitude:43.392535},time_offset:0,name:"8 мкр"}],type:"auto",schedules:[{times:[[5,35],[5,43],[5,51],[5,59],[6,7],[6,15],[6,23],[6,31],[6,39],[6,47],[6,55],[7,3],[7,11],[7,19],[7,27],[7,35],[7,43],[7,51],[7,59],[8,7],[8,15],[8,23],[8,31],[8,39],[8,47],[8,55],[9,3],[9,11],[9,19],[9,27],[9,35],[9,43],[9,51],[9,59],[10,7],[10,15],[10,53],[11,1],[11,9],[11,17],[11,25],[11,33],[11,41],[11,49],[11,57],[12,5],[12,13],[12,21],[12,29],[12,37],[12,45],[12,53],[13,1],[13,9],[13,17],[13,25],[13,37],[13,45],[13,53],[14,1],[14,9],[14,17],[14,25],[14,33],[14,41],[14,49],[14,57],[15,5],[15,13],[15,21],[15,29],[15,37],[15,45],[15,53],[16,1],[16,9],[16,25],[16,41],[16,47],[16,57],[17,3],[17,13],[17,19],[17,29],[17,35],[17,45],[17,51],[18,1],[18,7],[18,17],[18,23],[18,33],[18,39],[18,49],[18,55],[19,11],[19,27],[19,35],[19,43],[19,51],[19,59],[20,7],[20,23],[20,39],[20,55],[21,19]],to:"a-401k-nn"}],id:"a-401k-dzr",name:"Транслайн Дзержинск"},{places:[{location:{latitude:56.322472,longitude:43.948036},name:"На стоянке"}],type:"auto",schedules:[{times:[[6,55],[7,11],[7,27],[7,43],[7,51],[7,59],[8,7],[8,15],[8,23],[8,31],[8,39],[8,47],[8,55],[9,11],[9,27],[9,33],[9,43],[9,49],[9,59],[10,5],[10,15],[10,21],[10,31],[10,37],[10,47],[10,53],[11,3],[11,9],[11,19],[11,25],[11,35],[11,41],[11,57],[15,5],[15,13],[15,21],[15,29],[15,37],[15,45],[15,53],[16,1],[16,9],[16,17],[16,25],[16,33],[16,41],[16,49],[16,57],[17,5],[17,13],[17,21],[17,29],[18,7],[18,15],[18,23],[18,31],[18,39],[18,47],[18,55],[19,3],[19,11],[19,19],[19,27],[19,35],[19,43],[19,51],[19,59],[20,7],[20,15],[20,23],[20,31],[20,39],[20,47],[20,55],[21,3],[21,11],[21,19],[21,27],[21,43],[21,59],[22,15],[22,39]],to:"a-401k-dzr"}],id:"a-401k-nn",name:"Транслайн НН"}]}}(),function(){"use strict";angular.module("schedully",["ngTouch","ngMaterial","angularMoment","ngGeolocation","ngStorage"])}(),function(){"use strict";function e(e,o,t,n,a){function i(){s(),l(),e(s,36e5),e(l,5e3),e(u,500)}function s(){t.info("Prepare data for new day"),h.appDB=_.cloneDeep(window.APP_DB),h.locationsById={},y={},angular.forEach(h.appDB.locations,function(e){h.locationsById[e.id]=e}),angular.forEach(h.appDB.locations,function(e){angular.forEach(e.schedules,function(o){e.id in y||(y[e.id]={}),y[e.id][o.to]=o;for(var t=0;t<o.times.length;t++){var n=g();n.setHours(o.times[t][0],o.times[t][1],0,0),0==o.times[t][0]&&n.setDate(n.getDate()+1),o.times[t]=n}})}),h.$storage.locationIdFrom&&h.$storage.locationIdFrom in h.locationsById||(h.$storage.locationIdFrom=h.appDB.locations[0].id),h.availableSchedules=h.locationsById[h.$storage.locationIdFrom].schedules}function l(){v&&(h.currentPosition={coords:{latitude:56.321376,longitude:43.955503,speed:2}}),p(),h.$storage.useGeoLocation&&c(),h.availableSchedules=h.locationsById[h.$storage.locationIdFrom].schedules,-1===_.findIndex(h.availableSchedules,"to",h.$storage.locationIdTo)&&(h.$storage.locationIdTo=h.availableSchedules[0].to),h.closestTimes=[];for(var e=g(),o=f(),t=h.locationsById[h.$storage.locationIdFrom].places[0].time_offset||0,n=0;n<o.times.length;n++){var a=o.times[n],i=moment(a).diff(e,"seconds")+t;if(h.$storage.showAllSchedules||i>=0){var s=moment(o.times[n+1]).diff(a,"minutes");0>s&&(s="n/a"),h.closestTimes.push({at:a,nextAfterMinutes:s})}}u()}function c(){return h.currentPosition&&h.currentPosition.coords?(h.appDB.locations=_.sortBy(h.appDB.locations,function(e){return e.places=_.sortBy(e.places,function(e){var o=haversine(h.currentPosition.coords,e.location);return e.distance=o,o}),e.places[0].distance}),!0):!1}function r(){if(c())h.$storage.locationIdFrom=h.appDB.locations[0].id,l();else if(h.$storage.useGeoLocation)a.alert().clickOutsideToClose(!0).title("Ошибка получения геолокации").content("Нет данных о положении. Ближайшее место не выбрано").ok("ОК");else{var e=a.confirm().title("Выбор ближайшего места").content("Для выбора ближайшего места необходимо включить геолокацию. <b>Включить?</b>").ok("Да").cancel("Нет");a.show(e).then(function(){h.$storage.useGeoLocation=!0,l()})}}function u(){d(),m()}function d(){if(!h.closestTimes.length)return void(h.timeToClosest=null);for(var e=g(),o=0,t=0;t<h.closestTimes.length;t++)if(o=moment(h.closestTimes[t].at).diff(e,"seconds"),o>0){h.closestTimes[t].isTracked=!0;break}if(0>=o)h.timeToClosest=null;else{var n=g();n.setHours(0,0,o,0),h.timeToClosest=n}}function m(){var e=h.locationsById[h.$storage.locationIdFrom].places[0].distance;if("undefined"!=typeof e&&(h.distance=(1e3*e).toFixed(2)),h.distance&&h.currentPosition){var o=1.38889;h.currentPosition.coords&&h.currentPosition.coords.speed&&(o=h.currentPosition.coords.speed);var t=h.distance/o;h.approximateETA=g().setHours(0,0,t,0)}}function f(){return y[h.$storage.locationIdFrom][h.$storage.locationIdTo]}function g(){if(v){var e=new Date;return e.setHours(9,30),e}return new Date}function p(){if($)h.$storage.useGeoLocation||($=!1,o.clearWatch());else if(h.$storage.useGeoLocation){var e={timeout:6e4,maximumAge:1e3,enableHighAccuracy:!0};o.getCurrentPosition(e).then(l),o.watchPosition(),$=!0}}var h=this,v=!1;h.refreshSchedule=l,h.selectNearestLocation=r,h.appDB=null,h.closestTimes=[],h.availableSchedules=[],h.locationsById={},h.currentPosition=o.position,h.distance=null,h.approximateETA=null,h.$storage=n.$default({useGeoLocation:!1,showAllSchedules:!1,locationIdTo:null,locationIdFrom:null});var y={};i();var $=!1}angular.module("schedully").controller("MainController",e),e.$inject=["$interval","$geolocation","$log","$localStorage","$mdDialog"]}(),function(){"use strict";function e(e,o){o.changeLocale("ru"),e.debug("runBlock end")}angular.module("schedully").run(e),e.$inject=["$log","amMoment"]}(),function(){"use strict";function e(e){e.debugEnabled(!0)}angular.module("schedully").config(e),e.$inject=["$logProvider"]}();